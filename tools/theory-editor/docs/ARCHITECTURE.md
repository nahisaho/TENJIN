# Theory Editor ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## æ¦‚è¦

Theory Editorã¯ã€ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ãŸã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSPAï¼‰ã§ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Theory Editor                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  index.html â”‚  â”‚  styles.css â”‚  â”‚      app.js         â”‚ â”‚
â”‚  â”‚   (View)    â”‚  â”‚   (Style)   â”‚  â”‚   (Controller)      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                              â”‚              â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                         â–¼                                â–¼ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    js/ Modules                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ validation  â”‚    diff     â”‚   storage   â”‚  error   â”‚   â”‚
â”‚  â”‚    .js      â”‚    .js      â”‚    .js      â”‚ handler  â”‚   â”‚
â”‚  â”‚             â”‚             â”‚             â”‚   .js    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              graphrag-sync.js                        â”‚   â”‚
â”‚  â”‚           (GraphRAG Integration)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   External Services                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     sync-server.py      â”‚           Neo4j                   â”‚
â”‚     (Port 8081)         â”‚        (Port 7687)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

### Core Modules

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | è²¬å‹™ | ä¾å­˜é–¢ä¿‚ |
|-----------|------|----------|
| `app.js` | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« |
| `validation.js` | ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | ãªã— |
| `diff.js` | å·®åˆ†è¨ˆç®— | ãªã— |
| `storage.js` | LocalStorageç®¡ç† | ãªã— |
| `error-handler.js` | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | ãªã— |
| `graphrag-sync.js` | GraphRAGé€£æº | ãªã— |

### ä¾å­˜é–¢ä¿‚å›³

```
app.js
â”œâ”€â”€ validation.js (TheoryValidation)
â”œâ”€â”€ diff.js (TheoryDiff)
â”œâ”€â”€ storage.js (TheoryStorage)
â”œâ”€â”€ error-handler.js (ErrorHandler)
â””â”€â”€ graphrag-sync.js (GraphRAGSync)
```

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### èª­ã¿è¾¼ã¿ãƒ•ãƒ­ãƒ¼

```
1. ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰
   â”‚
   â–¼
2. initializeApp()
   â”‚
   â”œâ”€â”€ loadDefaultData()
   â”‚   â”‚
   â”‚   â–¼
   â”‚   fetch('/data/theories/theories.json')
   â”‚   â”‚
   â”‚   â–¼
   â”‚   updateState({ theories, metadata })
   â”‚
   â”œâ”€â”€ loadVersionsFromStorage()
   â”‚   â”‚
   â”‚   â–¼
   â”‚   TheoryStorage.loadVersionsFromStorage()
   â”‚
   â””â”€â”€ renderTheoryList()
       â”‚
       â–¼
       DOMæ›´æ–°
```

### ä¿å­˜ãƒ•ãƒ­ãƒ¼

```
1. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ (handleSave)
   â”‚
   â–¼
2. collectFormData()
   â”‚
   â–¼
3. TheoryValidation.validateTheory()
   â”‚
   â”œâ”€â”€ å¤±æ•— â†’ showFieldError() â†’ çµ‚äº†
   â”‚
   â–¼ æˆåŠŸ
4. state.theories ã«è¿½åŠ /æ›´æ–°
   â”‚
   â–¼
5. TheoryStorage.saveVersion()
   â”‚
   â–¼
6. renderTheoryList()
   â”‚
   â–¼
7. setStatus('ä¿å­˜å®Œäº†', 'success')
```

### GraphRAGåŒæœŸãƒ•ãƒ­ãƒ¼

```
1. ã€ŒğŸ”„ GraphRAGåŒæœŸã€ã‚¯ãƒªãƒƒã‚¯
   â”‚
   â–¼
2. handleGraphRAGSync()
   â”‚
   â–¼
3. GraphRAGSync.triggerReindex()
   â”‚
   â–¼
4. POST http://localhost:8081/api/graphrag/sync
   â”‚
   â–¼
5. sync-server.py
   â”‚
   â”œâ”€â”€ theories.json ã‚’ã‚³ãƒ”ãƒ¼
   â”‚
   â””â”€â”€ uv run python -m tengin_mcp.scripts.seed_data
       â”‚
       â–¼
       Neo4j ã«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
```

## çŠ¶æ…‹ç®¡ç†

### Single State Object Pattern

```javascript
const state = {
  // ãƒ‡ãƒ¼ã‚¿
  theories: [],           // ç†è«–ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—
  metadata: null,         // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

  // UIçŠ¶æ…‹
  currentTheoryId: null,  // é¸æŠä¸­ã®ç†è«–ID
  searchQuery: '',        // æ¤œç´¢ã‚¯ã‚¨ãƒª
  categoryFilter: 'all',  // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
  isModified: false,      // æœªä¿å­˜ã®å¤‰æ›´

  // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
  versions: []            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´
};
```

### çŠ¶æ…‹æ›´æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
// âŒ ç›´æ¥å¤‰æ›´ã—ãªã„
state.currentTheoryId = 'theory-001';

// âœ“ updateState() ã‚’ä½¿ç”¨
updateState({ currentTheoryId: 'theory-001' });
```

## ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§

| ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒãƒ³ãƒ‰ãƒ© | èª¬æ˜ |
|---------|---------|------|
| `DOMContentLoaded` | `initializeApp` | åˆæœŸåŒ– |
| `click` (ç†è«–ãƒªã‚¹ãƒˆ) | `handleTheorySelect` | ç†è«–é¸æŠ |
| `submit` (ãƒ•ã‚©ãƒ¼ãƒ ) | `handleSave` | ä¿å­˜ |
| `click` (æ–°è¦) | `handleAdd` | æ–°è¦è¿½åŠ  |
| `click` (å‰Šé™¤) | `handleDeleteClick` | å‰Šé™¤ç¢ºèª |
| `click` (ç¢ºå®šå‰Šé™¤) | `handleConfirmDelete` | å‰Šé™¤å®Ÿè¡Œ |
| `input` (æ¤œç´¢) | `handleSearch` | æ¤œç´¢ |
| `change` (ã‚«ãƒ†ã‚´ãƒª) | `handleFilter` | ãƒ•ã‚£ãƒ«ã‚¿ |
| `click` (å±¥æ­´) | `openHistoryModal` | å±¥æ­´è¡¨ç¤º |
| `click` (åŒæœŸ) | `handleGraphRAGSync` | GraphRAGåŒæœŸ |

### ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

```javascript
function handleKeyboardShortcuts(e) {
  // Escape: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  if (e.key === 'Escape') {
    closeAllModals();
  }

  // Ctrl+S: ä¿å­˜
  if (e.ctrlKey && e.key === 's') {
    e.preventDefault();
    handleSave(e);
  }
}
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

### ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | å¯¾å¿œ | ä¾‹ |
|--------|------|-----|
| Validation | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º | å¿…é ˆé …ç›®æœªå…¥åŠ› |
| Warning | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º | ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ |
| Error | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º + ãƒ­ã‚° | ä¿å­˜å¤±æ•— |
| Critical | ã‚¢ãƒ©ãƒ¼ãƒˆ + ãƒªãƒ­ãƒ¼ãƒ‰ææ¡ˆ | ãƒ‡ãƒ¼ã‚¿ç ´æ |

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒ­ãƒ¼

```javascript
try {
  // å‡¦ç†
} catch (error) {
  const result = ErrorHandler.handleError(error, context);

  if (result.recoverable) {
    setStatus(result.message, 'error');
  } else {
    alert(result.message);
    // å¾©æ—§å‡¦ç†
  }

  // é–‹ç™ºæ™‚ãƒ­ã‚°
  ErrorHandler.logError(error, context);
}
```

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   E2E     â”‚  â† Playwright
        â”‚  (å°‘æ•°)   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚Integrationâ”‚  â† æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
        â”‚  (ä¸­ç¨‹åº¦) â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   Unit    â”‚  â† Node.js
        â”‚  (å¤šæ•°)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ | çµ±åˆãƒ†ã‚¹ãƒˆ |
|-----------|--------------|----------|
| validation.js | 10ä»¶ | âœ“ |
| diff.js | 8ä»¶ | âœ“ |
| storage.js | 10ä»¶ | âœ“ |
| error-handler.js | 13ä»¶ | âœ“ |

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®

### æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ

1. **ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**: ç†è«–ãƒªã‚¹ãƒˆãŒ1000ä»¶è¶…ã®å ´åˆã«æ¤œè¨
2. **ãƒ‡ãƒã‚¦ãƒ³ã‚¹**: æ¤œç´¢å…¥åŠ›ï¼ˆ300msï¼‰
3. **é…å»¶ãƒ­ãƒ¼ãƒ‰**: å¤§ããªãƒ‡ãƒ¼ã‚¿ã¯åˆ†å‰²å–å¾—
4. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: LocalStorageã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´

### ç¾åœ¨ã®åˆ¶é™

| é …ç›® | åˆ¶é™å€¤ | ç†ç”± |
|------|--------|------|
| ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ | 50ä»¶ | LocalStorageå®¹é‡ |
| ç†è«–ãƒ‡ãƒ¼ã‚¿ | ç„¡åˆ¶é™* | ãƒ¡ãƒ¢ãƒªä¾å­˜ |
| æ¤œç´¢ãƒ‡ãƒã‚¦ãƒ³ã‚¹ | ãªã— | 175ä»¶ãªã‚‰å³æ™‚ã§OK |

*å®Ÿç”¨çš„ã«ã¯1000ä»¶ç¨‹åº¦ã¾ã§

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®

### XSSå¯¾ç­–

```javascript
// âŒ ç›´æ¥HTMLæŒ¿å…¥ã—ãªã„
element.innerHTML = userInput;

// âœ“ ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æŒ¿å…¥
element.textContent = userInput;

// âœ“ ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
```

### ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

- ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã« `validateImportData()` ã§æ¤œè¨¼
- ä¿å­˜æ™‚ã« `validateTheory()` ã§æ¤œè¨¼
- ä¸æ­£ãªJSONã¯æ‹’å¦

## æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ

### æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

1. `js/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
3. `index.html` ã« `<script>` ã‚¿ã‚°è¿½åŠ 
4. `app.js` ã‹ã‚‰å‘¼ã³å‡ºã—

### æ–°ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

1. `index.html` ã«ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
2. `collectFormData()` ã§åé›†
3. `validation.js` ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«è¿½åŠ 
4. `seed_data.py` ã®ã‚¹ã‚­ãƒ¼ãƒæ›´æ–°ï¼ˆGraphRAGé€£æºæ™‚ï¼‰

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [README](../README.md)
- [API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](API.md)
- [è¨­è¨ˆæ›¸](../../../storage/specs/DESIGN-002-theory-editor.md)
