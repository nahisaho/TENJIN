<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TENJIN - 教育理論エディター</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Skip link for accessibility (TASK-012) -->
    <a href="#editor-form" class="skip-link">メインコンテンツへスキップ</a>
    
    <div id="app">
        <!-- ヘッダー -->
        <header class="header" role="banner">
            <h1>🎓 TENJIN 教育理論エディター</h1>
            <div class="header-actions">
                <button id="btn-history" class="btn btn-secondary" aria-label="履歴を表示">
                    📜 履歴
                </button>
                <button id="btn-import" class="btn btn-secondary" aria-label="JSONファイルをインポート">
                    📥 インポート
                </button>
                <button id="btn-export" class="btn btn-primary" aria-label="JSONファイルをエクスポート">
                    📤 エクスポート
                </button>
                <button id="btn-sync-graphrag" class="btn btn-warning" aria-label="GraphRAGと同期" title="GraphRAGインデックスを再作成">
                    🔄 GraphRAG同期
                </button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-content" role="main">
            <!-- サイドバー：理論一覧 -->
            <aside class="sidebar" role="navigation" aria-label="理論一覧サイドバー">
                <div class="sidebar-header">
                    <h2>理論一覧</h2>
                    <button id="btn-add" class="btn btn-success btn-sm" aria-label="新規理論を追加">
                        ＋ 新規追加
                    </button>
                </div>
                
                <!-- 検索・フィルター -->
                <div class="search-filter" role="search">
                    <input type="text" id="search-input" placeholder="🔍 検索..." class="search-input" aria-label="理論を検索">
                    <select id="category-filter" class="category-filter" aria-label="カテゴリでフィルタ">
                        <option value="">すべてのカテゴリ</option>
                    </select>
                </div>

                <!-- 統計情報 -->
                <div class="stats" aria-live="polite">
                    <span id="stats-count">0件</span>
                    <span id="stats-filtered" class="stats-filtered"></span>
                </div>

                <!-- 理論リスト -->
                <ul id="theory-list" class="theory-list" role="listbox" aria-label="理論一覧">
                    <!-- 動的に生成 -->
                </ul>
            </aside>

            <!-- エディターパネル -->
            <section class="editor-panel" aria-label="理論エディター">
                <div id="editor-placeholder" class="editor-placeholder">
                    <p>👈 左の一覧から理論を選択するか、<br>「＋ 新規追加」で新しい理論を作成してください</p>
                </div>
                
                <form id="editor-form" class="editor-form hidden">
                    <div class="editor-header">
                        <h2 id="editor-title">理論を編集</h2>
                        <div class="editor-actions">
                            <button type="button" id="btn-history-theory" class="btn btn-secondary btn-sm" title="この理論の変更履歴">
                                📜
                            </button>
                            <button type="button" id="btn-delete" class="btn btn-danger">
                                🗑️ 削除
                            </button>
                            <button type="submit" class="btn btn-primary">
                                💾 保存
                            </button>
                        </div>
                    </div>

                    <!-- 基本情報 -->
                    <fieldset class="fieldset">
                        <legend>基本情報</legend>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="theory-id">ID <span class="label-hint">（自動生成）</span></label>
                                <input type="text" id="theory-id" readonly class="input-readonly" aria-describedby="id-hint">
                                <span id="id-hint" class="visually-hidden">IDは自動的に生成されます</span>
                            </div>
                            <div class="form-group">
                                <label for="theory-priority">優先度</label>
                                <select id="theory-priority">
                                    <option value="5">5 (最高)</option>
                                    <option value="4">4 (高)</option>
                                    <option value="3">3 (中)</option>
                                    <option value="2">2 (低)</option>
                                    <option value="1">1 (最低)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="theory-name">英語名 *</label>
                                <input type="text" id="theory-name" required>
                            </div>
                            <div class="form-group">
                                <label for="theory-name-ja">日本語名</label>
                                <input type="text" id="theory-name-ja">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="theory-category">カテゴリ *</label>
                            <select id="theory-category" required>
                                <option value="">選択してください</option>
                                <option value="learning_theory">学習理論</option>
                                <option value="developmental">発達理論</option>
                                <option value="motivation">動機づけ理論</option>
                                <option value="instructional_design">教授設計</option>
                                <option value="social_learning">社会的学習</option>
                                <option value="curriculum">カリキュラム</option>
                                <option value="assessment">評価</option>
                                <option value="technology_enhanced">テクノロジー活用</option>
                                <option value="asian_education">アジア教育思想</option>
                                <option value="modern_education">現代教育</option>
                                <option value="critical_alternative_special">批判的・代替教育</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="theory-theorists">理論家（カンマ区切り）</label>
                            <input type="text" id="theory-theorists" placeholder="例: John Dewey, Jean Piaget">
                        </div>
                    </fieldset>

                    <!-- 説明 -->
                    <fieldset class="fieldset">
                        <legend>説明</legend>
                        
                        <div class="form-group">
                            <label for="theory-description">英語説明 *</label>
                            <textarea id="theory-description" rows="4" required></textarea>
                            <div class="char-count"><span id="desc-count">0</span> 文字</div>
                        </div>

                        <div class="form-group">
                            <label for="theory-description-ja">日本語説明</label>
                            <textarea id="theory-description-ja" rows="4"></textarea>
                            <div class="char-count"><span id="desc-ja-count">0</span> 文字</div>
                        </div>
                    </fieldset>

                    <!-- 主要原則 -->
                    <fieldset class="fieldset">
                        <legend>主要原則 (Key Principles)</legend>
                        <div id="principles-container" class="array-container">
                            <!-- 動的に生成 -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addArrayItem('principles')">
                            ＋ 原則を追加
                        </button>
                    </fieldset>

                    <!-- 応用 -->
                    <fieldset class="fieldset">
                        <legend>応用 (Applications)</legend>
                        <div id="applications-container" class="array-container">
                            <!-- 動的に生成 -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addArrayItem('applications')">
                            ＋ 応用を追加
                        </button>
                    </fieldset>

                    <!-- 強み -->
                    <fieldset class="fieldset">
                        <legend>強み (Strengths)</legend>
                        <div id="strengths-container" class="array-container">
                            <!-- 動的に生成 -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addArrayItem('strengths')">
                            ＋ 強みを追加
                        </button>
                    </fieldset>

                    <!-- 限界 -->
                    <fieldset class="fieldset">
                        <legend>限界 (Limitations)</legend>
                        <div id="limitations-container" class="array-container">
                            <!-- 動的に生成 -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" onclick="addArrayItem('limitations')">
                            ＋ 限界を追加
                        </button>
                    </fieldset>
                </form>
            </section>
        </main>

        <!-- ステータスバー -->
        <footer class="status-bar" role="status" aria-live="polite">
            <span id="status-message">準備完了</span>
            <span id="status-modified" class="status-modified hidden" aria-live="assertive">● 未保存の変更あり</span>
        </footer>
    </div>

    <!-- モーダル：削除確認 -->
    <div id="modal-delete" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-delete-title">
        <div class="modal-content">
            <h3 id="modal-delete-title">削除の確認</h3>
            <p id="modal-delete-desc">この理論を削除してもよろしいですか？</p>
            <p class="modal-theory-name" id="modal-delete-name" aria-live="polite"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('delete')">キャンセル</button>
                <button class="btn btn-danger" id="btn-confirm-delete" aria-describedby="modal-delete-desc">削除する</button>
            </div>
        </div>
    </div>

    <!-- モーダル：バージョン履歴 -->
    <div id="modal-history" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-history-title">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modal-history-title">📜 バージョン履歴</h3>
                <button class="btn-close" onclick="closeModal('history')" aria-label="履歴モーダルを閉じる">✕</button>
            </div>
            <div class="version-stats" aria-live="polite">
                <span id="version-count">0件のバージョン</span>
                <span id="storage-usage">使用容量: 0 KB</span>
            </div>
            <div class="version-list-container">
                <table class="version-table" role="grid" aria-label="バージョン一覧">
                    <thead>
                        <tr>
                            <th scope="col">バージョン</th>
                            <th scope="col">日時</th>
                            <th scope="col">説明</th>
                            <th scope="col">理論数</th>
                            <th scope="col">操作</th>
                        </tr>
                    </thead>
                    <tbody id="version-list">
                        <!-- 動的に生成 -->
                    </tbody>
                </table>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger btn-sm" id="btn-clear-history">🗑️ 全履歴を削除</button>
                <button class="btn btn-secondary" onclick="closeModal('history')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- モーダル：バージョン保存 -->
    <div id="modal-save-version" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-save-version-title">
        <div class="modal-content">
            <h3 id="modal-save-version-title">💾 バージョンを保存</h3>
            <div class="form-group">
                <label for="version-description">変更内容の説明</label>
                <input type="text" id="version-description" placeholder="例: 新理論5件追加、説明文を修正" aria-describedby="version-description-hint">
                <span id="version-description-hint" class="visually-hidden">任意の説明を入力してください</span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('save-version')">キャンセル</button>
                <button class="btn btn-primary" id="btn-confirm-save-version">保存する</button>
            </div>
        </div>
    </div>

    <!-- モーダル：差分表示 -->
    <div id="modal-diff" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-diff-title">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modal-diff-title">📊 バージョン比較</h3>
                <button class="btn-close" onclick="closeModal('diff')" aria-label="差分モーダルを閉じる">✕</button>
            </div>
            <div id="diff-content" class="diff-content" role="region" aria-label="差分表示エリア">
                <!-- 動的に生成 -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('diff')">閉じる</button>
            </div>
        </div>
    </div>

    <!-- ファイル入力 (非表示) -->
    <input type="file" id="file-input" accept=".json" style="display:none">

    <!-- モジュール読み込み（app.jsより先に読み込む） -->
    <script src="js/validation.js"></script>
    <script src="js/diff.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/graphrag-sync.js"></script>
    
    <!-- メインアプリケーション -->
    <script src="app.js"></script>
</body>
</html>
